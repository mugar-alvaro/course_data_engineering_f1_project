version: 2

unit_tests:
  - name: fct_F1__race_results_status_outcome_unit_test
    description: "Validates status_outcome classification in fct_F1__race_results based on dim_F1__status.status_description."
    model: fct_F1__race_results

    overrides:
      macros:
        is_incremental: false

    given:
      - input: ref('stg_F1__results')
        rows:
          - {
              race_result_surrogate_key: 'SK_RES_1',
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_1',
              constructor_surrogate_key: 'SK_CON_1',
              race_status_surrogate_key: 'SK_FIN',
              race_result_id: 1,
              race_id: 1001,
              driver_id: 44,
              constructor_id: 1,
              race_status_id: 1,
              car_number: 44,
              race_grid_position: 1,
              race_position: 1,
              race_position_label: '1',
              race_final_position_order: 1,
              race_points: 25,
              race_laps_completed: 58,
              race_duration_milliseconds: 5400000,
              race_fastest_lap: 50,
              race_fastest_lap_rank: 1,
              race_fastest_lap_time_milliseconds: 77000,
              race_fastest_lap_top_speed: 320.5,
              is_inconsistent_fastest_lap: false,
              duplicate_race_result_count: 1,
              ingestion_timestamp: '2025-01-01 00:00:00'
            }

          - {
              race_result_surrogate_key: 'SK_RES_2',
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_2',
              constructor_surrogate_key: 'SK_CON_1',
              race_status_surrogate_key: 'SK_PLUS_LAP',
              race_result_id: 2,
              race_id: 1001,
              driver_id: 77,
              constructor_id: 1,
              race_status_id: 2,
              car_number: 77,
              race_grid_position: 5,
              race_position: 5,
              race_position_label: '5',
              race_final_position_order: 5,
              race_points: 10,
              race_laps_completed: 57,
              race_duration_milliseconds: 5420000,
              race_fastest_lap: null,
              race_fastest_lap_rank: null,
              race_fastest_lap_time_milliseconds: null,
              race_fastest_lap_top_speed: null,
              is_inconsistent_fastest_lap: false,
              duplicate_race_result_count: 1,
              ingestion_timestamp: '2025-01-01 00:00:00'
            }

          - {
              race_result_surrogate_key: 'SK_RES_3',
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_3',
              constructor_surrogate_key: 'SK_CON_2',
              race_status_surrogate_key: 'SK_DSQ',
              race_result_id: 3,
              race_id: 1002,
              driver_id: 11,
              constructor_id: 2,
              race_status_id: 3,
              car_number: 11,
              race_grid_position: 3,
              race_position: null,
              race_position_label: 'DQ',
              race_final_position_order: null,
              race_points: 0,
              race_laps_completed: 40,
              race_duration_milliseconds: 4000000,
              race_fastest_lap: null,
              race_fastest_lap_rank: null,
              race_fastest_lap_time_milliseconds: null,
              race_fastest_lap_top_speed: null,
              is_inconsistent_fastest_lap: false,
              duplicate_race_result_count: 1,
              ingestion_timestamp: '2025-01-01 00:00:00'
            }

          - {
              race_result_surrogate_key: 'SK_RES_4',
              race_surrogate_key: 'SK_RACE_C',
              driver_surrogate_key: 'SK_DRV_4',
              constructor_surrogate_key: 'SK_CON_3',
              race_status_surrogate_key: 'SK_DNQ',
              race_result_id: 4,
              race_id: 1003,
              driver_id: 99,
              constructor_id: 3,
              race_status_id: 4,
              car_number: 99,
              race_grid_position: null,
              race_position: null,
              race_position_label: 'DNQ',
              race_final_position_order: null,
              race_points: 0,
              race_laps_completed: 0,
              race_duration_milliseconds: null,
              race_fastest_lap: null,
              race_fastest_lap_rank: null,
              race_fastest_lap_time_milliseconds: null,
              race_fastest_lap_top_speed: null,
              is_inconsistent_fastest_lap: false,
              duplicate_race_result_count: 1,
              ingestion_timestamp: '2025-01-01 00:00:00'
            }

          - {
              race_result_surrogate_key: 'SK_RES_5',
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_5',
              constructor_surrogate_key: 'SK_CON_2',
              race_status_surrogate_key: 'SK_ENGINE',
              race_result_id: 5,
              race_id: 1002,
              driver_id: 5,
              constructor_id: 2,
              race_status_id: 5,
              car_number: 5,
              race_grid_position: 8,
              race_position: null,
              race_position_label: 'DNF',
              race_final_position_order: null,
              race_points: 0,
              race_laps_completed: 30,
              race_duration_milliseconds: 3500000,
              race_fastest_lap: null,
              race_fastest_lap_rank: null,
              race_fastest_lap_time_milliseconds: null,
              race_fastest_lap_top_speed: null,
              is_inconsistent_fastest_lap: false,
              duplicate_race_result_count: 1,
              ingestion_timestamp: '2025-01-01 00:00:00'
            }

      - input: ref('dim_F1__races')
        rows:
          - {
              race_key: 'SK_RACE_A',
              race_id: 1001,
              race_year: 2020,
              round_number: 1,
              race_name: 'Test Race A',
              race_display_name: '2020 - Test Race A',
              circuit_surrogate_key: 'SK_CIR_1',
              circuit_id: 100,
              race_date: '2020-07-05',
              race_time_of_day: '15:10:00',
              race_datetime_utc: '2020-07-05 15:10:00',
              race_weekday_name: 'Sun',
              race_month_number: 7,
              race_month_name: 'Jul'
            }
          - {
              race_key: 'SK_RACE_B',
              race_id: 1002,
              race_year: 2021,
              round_number: 2,
              race_name: 'Test Race B',
              race_display_name: '2021 - Test Race B',
              circuit_surrogate_key: 'SK_CIR_2',
              circuit_id: 200,
              race_date: '2021-05-23',
              race_time_of_day: '14:00:00',
              race_datetime_utc: '2021-05-23 14:00:00',
              race_weekday_name: 'Sun',
              race_month_number: 5,
              race_month_name: 'May'
            }
          - {
              race_key: 'SK_RACE_C',
              race_id: 1003,
              race_year: 2019,
              round_number: 3,
              race_name: 'Test Race C',
              race_display_name: '2019 - Test Race C',
              circuit_surrogate_key: 'SK_CIR_3',
              circuit_id: 300,
              race_date: '2019-03-10',
              race_time_of_day: '13:00:00',
              race_datetime_utc: '2019-03-10 13:00:00',
              race_weekday_name: 'Sun',
              race_month_number: 3,
              race_month_name: 'Mar'
            }

      - input: ref('dim_F1__circuits')
        rows:
          - {
              circuit_key: 'SK_CIR_1',
              circuit_id: 100,
              circuit_reference: 'c1',
              circuit_name: 'Circuit 1',
              circuit_display_name: 'Circuit 1 (City1, Country1)',
              city: 'City1',
              country: 'Country1',
              latitude: 0.0,
              longitude: 0.0,
              altitude_meters: 10,
              hemisphere: 'NORTH',
              altitude_category: 'LOW',
              is_high_altitude_circuit: false
            }
          - {
              circuit_key: 'SK_CIR_2',
              circuit_id: 200,
              circuit_reference: 'c2',
              circuit_name: 'Circuit 2',
              circuit_display_name: 'Circuit 2 (City2, Country2)',
              city: 'City2',
              country: 'Country2',
              latitude: 10.0,
              longitude: 10.0,
              altitude_meters: 50,
              hemisphere: 'NORTH',
              altitude_category: 'LOW',
              is_high_altitude_circuit: false
            }
          - {
              circuit_key: 'SK_CIR_3',
              circuit_id: 300,
              circuit_reference: 'c3',
              circuit_name: 'Circuit 3',
              circuit_display_name: 'Circuit 3 (City3, Country3)',
              city: 'City3',
              country: 'Country3',
              latitude: -5.0,
              longitude: 20.0,
              altitude_meters: 100,
              hemisphere: 'SOUTH',
              altitude_category: 'LOW',
              is_high_altitude_circuit: false
            }

      - input: ref('dim_F1__seasons')
        rows:
          - {
              season_key: 'SK_SEASON_2020',
              season_year: 2020,
              season_name: 'Season 2020',
              season_decade: 2020,
              season_era: 'HYBRID_ERA'
            }
          - {
              season_key: 'SK_SEASON_2021',
              season_year: 2021,
              season_name: 'Season 2021',
              season_decade: 2020,
              season_era: 'HYBRID_ERA'
            }
          - {
              season_key: 'SK_SEASON_2019',
              season_year: 2019,
              season_name: 'Season 2019',
              season_decade: 2010,
              season_era: 'MODERN'
            }

      - input: ref('dim_F1__status')
        rows:
          - { status_key: 'SK_FIN',      status_id: 1, status_description: 'Finished' }
          - { status_key: 'SK_PLUS_LAP', status_id: 2, status_description: '+1 Lap' }
          - { status_key: 'SK_DSQ',      status_id: 3, status_description: 'Disqualified' }
          - { status_key: 'SK_DNQ',      status_id: 4, status_description: 'Did not qualify' }
          - { status_key: 'SK_ENGINE',   status_id: 5, status_description: 'Engine' }

      - input: ref('int_F1__lap_times_aggregated')
        rows:
          - {
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_1',
              laps_from_lap_times: 58,
              best_lap_time_milliseconds: 77000,
              avg_lap_time_milliseconds: 80000,
              total_lap_time_milliseconds: 4640000,
              best_lap_position: 1,
              worst_lap_position: 3,
              avg_lap_position: 1.5,
              lap_match_category: 'match',
              lap_data_mismatch_flag: false
            }
          - {
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_2',
              laps_from_lap_times: 57,
              best_lap_time_milliseconds: 79000,
              avg_lap_time_milliseconds: 82000,
              total_lap_time_milliseconds: 4670000,
              best_lap_position: 3,
              worst_lap_position: 8,
              avg_lap_position: 5.0,
              lap_match_category: 'match',
              lap_data_mismatch_flag: false
            }
          - {
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_3',
              laps_from_lap_times: 40,
              best_lap_time_milliseconds: 90000,
              avg_lap_time_milliseconds: 93000,
              total_lap_time_milliseconds: 3720000,
              best_lap_position: 4,
              worst_lap_position: 12,
              avg_lap_position: 8.0,
              lap_match_category: 'match',
              lap_data_mismatch_flag: false
            }
          - {
              race_surrogate_key: 'SK_RACE_C',
              driver_surrogate_key: 'SK_DRV_4',
              laps_from_lap_times: 0,
              best_lap_time_milliseconds: null,
              avg_lap_time_milliseconds: null,
              total_lap_time_milliseconds: null,
              best_lap_position: null,
              worst_lap_position: null,
              avg_lap_position: null,
              lap_match_category: 'no_data',
              lap_data_mismatch_flag: false
            }
          - {
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_5',
              laps_from_lap_times: 30,
              best_lap_time_milliseconds: 95000,
              avg_lap_time_milliseconds: 98000,
              total_lap_time_milliseconds: 2940000,
              best_lap_position: 6,
              worst_lap_position: 15,
              avg_lap_position: 10.0,
              lap_match_category: 'match',
              lap_data_mismatch_flag: false
            }

      - input: ref('int_F1__pit_stops_aggregated')
        rows:
          - {
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_1',
              pit_stop_count: 2,
              best_pit_stop_duration_milliseconds: 2200,
              worst_pit_stop_duration_milliseconds: 2600,
              avg_pit_stop_duration_milliseconds: 2400,
              total_pit_stop_duration_milliseconds: 4800,
              first_pit_lap_number: 15,
              last_pit_lap_number: 40
            }
          - {
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_2',
              pit_stop_count: 2,
              best_pit_stop_duration_milliseconds: 2300,
              worst_pit_stop_duration_milliseconds: 2700,
              avg_pit_stop_duration_milliseconds: 2500,
              total_pit_stop_duration_milliseconds: 5000,
              first_pit_lap_number: 18,
              last_pit_lap_number: 42
            }
          - {
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_3',
              pit_stop_count: 1,
              best_pit_stop_duration_milliseconds: 2500,
              worst_pit_stop_duration_milliseconds: 2500,
              avg_pit_stop_duration_milliseconds: 2500,
              total_pit_stop_duration_milliseconds: 2500,
              first_pit_lap_number: 20,
              last_pit_lap_number: 20
            }
          - {
              race_surrogate_key: 'SK_RACE_C',
              driver_surrogate_key: 'SK_DRV_4',
              pit_stop_count: 0,
              best_pit_stop_duration_milliseconds: null,
              worst_pit_stop_duration_milliseconds: null,
              avg_pit_stop_duration_milliseconds: null,
              total_pit_stop_duration_milliseconds: null,
              first_pit_lap_number: null,
              last_pit_lap_number: null
            }
          - {
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_5',
              pit_stop_count: 1,
              best_pit_stop_duration_milliseconds: 2600,
              worst_pit_stop_duration_milliseconds: 2600,
              avg_pit_stop_duration_milliseconds: 2600,
              total_pit_stop_duration_milliseconds: 2600,
              first_pit_lap_number: 10,
              last_pit_lap_number: 10
            }

      - input: ref('int_F1__qualifying_aggregated')
        rows:
          - {
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_1',
              qualifying_position: 1,
              best_qualifying_time_milliseconds: 73000,
              qualifying_sessions_entered: 3,
              qualified_for_q2: true,
              qualified_for_q3: true
            }
          - {
              race_surrogate_key: 'SK_RACE_A',
              driver_surrogate_key: 'SK_DRV_2',
              qualifying_position: 5,
              best_qualifying_time_milliseconds: 76000,
              qualifying_sessions_entered: 3,
              qualified_for_q2: true,
              qualified_for_q3: true
            }
          - {
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_3',
              qualifying_position: 3,
              best_qualifying_time_milliseconds: 80000,
              qualifying_sessions_entered: 2,
              qualified_for_q2: true,
              qualified_for_q3: false
            }
          - {
              race_surrogate_key: 'SK_RACE_C',
              driver_surrogate_key: 'SK_DRV_4',
              qualifying_position: null,
              best_qualifying_time_milliseconds: null,
              qualifying_sessions_entered: 0,
              qualified_for_q2: false,
              qualified_for_q3: false
            }
          - {
              race_surrogate_key: 'SK_RACE_B',
              driver_surrogate_key: 'SK_DRV_5',
              qualifying_position: 8,
              best_qualifying_time_milliseconds: 82000,
              qualifying_sessions_entered: 1,
              qualified_for_q2: false,
              qualified_for_q3: false
            }

    expect:
      rows:
        - {
            race_result_key: 'SK_RES_1',
            race_id: 1001,
            driver_id: 44,
            race_status_id: 1,
            status_outcome: 'FINISHED'
          }

        - {
            race_result_key: 'SK_RES_2',
            race_id: 1001,
            driver_id: 77,
            race_status_id: 2,
            status_outcome: 'FINISHED'
          }

        - {
            race_result_key: 'SK_RES_3',
            race_id: 1002,
            driver_id: 11,
            race_status_id: 3,
            status_outcome: 'DISQUALIFIED'
          }

        - {
            race_result_key: 'SK_RES_4',
            race_id: 1003,
            driver_id: 99,
            race_status_id: 4,
            status_outcome: 'NOT_STARTED_OR_CLASSIFIED'
          }

        - {
            race_result_key: 'SK_RES_5',
            race_id: 1002,
            driver_id: 5,
            race_status_id: 5,
            status_outcome: 'DNF'
          }
